---
title: 文件上传使用指南
date: 2025-09-24 16:31:00
permalink: /pages/file-upload-guide
categories:
  - 使用指南
  - 功能模块
tags:
  - 文件上传
  - x-file-storage
  - 存储服务
  - 云存储
article: true
sidebar: true
inCatalogue: true
autoTitle: true
articleUpdate: true
inHomePost: true
description: 详细的 x-file-storage 文件上传使用指南，包含基础用法、高级特性和多种存储平台配置，帮助开发者快速集成文件上传功能。
coverImg: /img/upload.png
---

# 文件上传使用指南

## 概述

`x-file-storage` 是一个强大的文件存储框架，支持多种存储平台，提供了简洁的 API 和丰富的功能，包括文件上传、图片处理、缩略图生成等特性。

## 核心功能

- **多平台支持**: 支持本地存储、阿里云 OSS、腾讯云 COS、七牛云等
- **简洁 API**: 提供流畅的链式 API 调用
- **图片处理**: 集成 Thumbnailator，支持图片缩放、裁剪等
- **缩略图生成**: 自动生成缩略图
- **元数据管理**: 支持文件属性和关联对象管理
- **扩展性强**: 易于扩展新的存储平台

## 核心依赖

```java
import org.dromara.x.file.storage.core.FileInfo;
import org.dromara.x.file.storage.core.FileStorageService;
import org.noear.solon.core.handle.UploadedFile;
```

## 基础使用

### 简单文件上传

```java
/**
 * 上传文件
 */
@Mapping("/upload")
@NoRepeatSubmit
@SaCheckPermission("system:file:upload")
@Log(title = "上传文件", businessType = BusinessType.UPLOAD)
public FileInfo upload(UploadedFile file) {
    return fileStorageService.of(file).upload();
}
```

### 多种数据源支持

`x-file-storage` 支持多种数据源类型：

1. **UploadedFile**: Web 上传的文件
2. **File**: 本地文件对象
3. **byte[]**: 字节数组
4. **InputStream**: 输入流
5. **URL**: 网络资源
6. **URI**: 统一资源标识符
7. **String**: 文件路径

## 高级用法

### 1. 指定保存路径

```java
// 上传到指定路径下
fileStorageService.of(file)
        .setPath("upload/") // 保存到相对路径下，为了方便管理，不需要可以不写
        .upload();
```

### 2. 关联业务对象

```java
// 关联文件参数并上传
fileStorageService.of(file)
        .setObjectId("0")   // 关联对象id，为了方便管理，不需要可以不写
        .setObjectType("0") // 关联对象类型，为了方便管理，不需要可以不写
        .putAttr("role", "admin")     // 保存一些属性，可以在切面、保存上传记录、自定义存储平台等地方获取使用
        .putAttr("username", "007")
        .upload();
```

### 3. 指定存储平台

```java
// 上传到指定的存储平台
fileStorageService.of(file)
        .setPlatform("aliyun-oss-1")    // 使用指定的存储平台
        .upload();
```

### 4. 图片处理

```java
// 对图片进行处理并上传，有多个重载方法
fileStorageService.of(file)
        .setThumbnailSuffix(".jpg")      // 指定缩略图后缀，必须是 thumbnailator 支持的图片格式，默认使用全局的
        .setSaveThFilename("thabc")      // 指定缩略图的保存文件名，注意此文件名不含后缀，默认自动生成
        .image(img -> img.size(1000, 1000))  // 将图片大小调整到 1000*1000
        .thumbnail(th -> th.size(200, 200))   // 再生成一张 200*200 的缩略图
        .upload();
```

### 5. 字节流上传

```java
// 如果要用 byte[]、InputStream、URL、URI、String 等方式上传，暂时无法获取 originalFilename 属性，最好手动设置
fileStorageService.of(inputStream)
        .setOriginalFilename("a.jpg")
        .upload();
```

## 完整示例

### 文件上传控制器

```java
import org.dromara.x.file.storage.core.FileInfo;
import org.dromara.x.file.storage.core.FileStorageService;
import org.noear.solon.annotation.Controller;
import org.noear.solon.annotation.Mapping;
import org.noear.solon.annotation.Post;
import org.noear.solon.core.handle.UploadedFile;
import cn.dev33.satoken.annotation.SaCheckPermission;
import com.jimuqu.common.log.annotation.Log;
import com.jimuqu.common.log.enums.BusinessType;
import org.noear.solon.validation.annotation.NoRepeatSubmit;

/**
 * 文件上传控制器
 */
@Post
@Controller
@Mapping("/system/file")
public class SysFileController {

    private final FileStorageService fileStorageService;

    public SysFileController(FileStorageService fileStorageService) {
        this.fileStorageService = fileStorageService;
    }

    /**
     * 基础文件上传
     */
    @Mapping("/upload")
    @NoRepeatSubmit
    @SaCheckPermission("system:file:upload")
    @Log(title = "上传文件", businessType = BusinessType.UPLOAD)
    public FileInfo upload(UploadedFile file) {
        return fileStorageService.of(file).upload();
    }

    /**
     * 图片上传并处理
     */
    @Mapping("/uploadImage")
    @NoRepeatSubmit
    @SaCheckPermission("system:file:upload")
    @Log(title = "上传图片", businessType = BusinessType.UPLOAD)
    public FileInfo uploadImage(UploadedFile file) {
        return fileStorageService.of(file)
                .setPath("images/")           // 保存到 images 目录
                .setObjectType("avatar")      // 对象类型为头像
                .image(img -> img.size(800, 800))  // 限制图片大小为 800x800
                .thumbnail(th -> th.size(200, 200)) // 生成 200x200 缩略图
                .upload();
    }

    /**
     * 文档上传
     */
    @Mapping("/uploadDocument")
    @NoRepeatSubmit
    @SaCheckPermission("system:file:upload")
    @Log(title = "上传文档", businessType = BusinessType.UPLOAD)
    public FileInfo uploadDocument(UploadedFile file) {
        return fileStorageService.of(file)
                .setPath("documents/")        // 保存到 documents 目录
                .setObjectType("document")     // 对象类型为文档
                .putAttr("category", "contract") // 添加分类属性
                .upload();
    }
}
```

## 存储平台配置

### 本地存储配置

```yaml
jimuqu:
  file-storage:
    # 默认存储平台
    default-platform: local-plus
    # 存储平台配置
    platforms:
      # 本地存储
      local-plus:
        platform: local-plus
        enable-storage: true
        enable-access: true
        domain: "http://localhost:8080/files/"
        base-path: "upload/"
        storage-path: "D:/upload/"
```

### 阿里云 OSS 配置

```yaml
jimuqu:
  file-storage:
    default-platform: aliyun-oss-1
    platforms:
      aliyun-oss-1:
        platform: aliyun-oss
        enable-storage: true
        enable-access: true
        domain: "https://your-bucket.oss-cn-hangzhou.aliyuncs.com/"
        base-path: "upload/"
        bucket-name: "your-bucket"
        access-key: "your-access-key"
        secret-key: "your-secret-key"
        endpoint: "https://oss-cn-hangzhou.aliyuncs.com"
```

### 腾讯云 COS 配置

```yaml
jimuqu:
  file-storage:
    default-platform: tencent-cos-1
    platforms:
      tencent-cos-1:
        platform: tencent-cos
        enable-storage: true
        enable-access: true
        domain: "https://your-bucket.cos.ap-guangzhou.myqcloud.com/"
        base-path: "upload/"
        bucket-name: "your-bucket"
        secret-id: "your-secret-id"
        secret-key: "your-secret-key"
        region: "ap-guangzhou"
```

## 最佳实践

### 1. 文件类型验证

```java
@PostMapping("/uploadWithCheck")
public FileInfo uploadWithCheck(UploadedFile file) {
    // 验证文件类型
    String contentType = file.contentType();
    if (!contentType.startsWith("image/")) {
        throw new RuntimeException("只支持图片文件");
    }

    // 验证文件大小
    if (file.size() > 10 * 1024 * 1024) { // 10MB
        throw new RuntimeException("文件大小不能超过 10MB");
    }

    return fileStorageService.of(file).upload();
}
```

### 2. 文件命名策略

```java
@PostMapping("/uploadWithCustomName")
public FileInfo uploadWithCustomName(UploadedFile file) {
    // 生成自定义文件名
    String originalName = file.name();
    String extension = originalName.substring(originalName.lastIndexOf("."));
    String customName = "avatar_" + System.currentTimeMillis() + extension;

    return fileStorageService.of(file)
            .setOriginalFilename(customName)
            .setPath("avatars/")
            .upload();
}
```

### 3. 业务关联

```java
@PostMapping("/uploadForUser")
public FileInfo uploadForUser(@RequestParam Long userId, UploadedFile file) {
    return fileStorageService.of(file)
            .setObjectId(userId.toString())   // 关联用户ID
            .setObjectType("user-avatar")     // 对象类型为用户头像
            .setPath("users/" + userId + "/") // 按用户ID分目录存储
            .putAttr("upload-user", "admin")  // 上传用户
            .upload();
}
```

### 4. 批量上传

```java
@PostMapping("/batchUpload")
public List<FileInfo> batchUpload(@RequestParam List<UploadedFile> files) {
    return files.stream()
            .map(file -> fileStorageService.of(file)
                    .setPath("batch/" + DateUtil.today() + "/")
                    .upload())
            .collect(Collectors.toList());
}
```

## 返回信息说明

上传成功后返回的 `FileInfo` 对象包含以下信息：

```java
public class FileInfo {
    private String url;           // 文件访问地址
    private String filename;      // 文件名
    private String originalFilename; // 原始文件名
    private String basePath;      // 基础路径
    private String path;          // 相对路径
    private String platform;      // 存储平台
    private Long size;           // 文件大小
    private String contentType;   // 文件类型
    private String objectId;     // 关联对象ID
    private String objectType;   // 关联对象类型
    private Map<String, Object> attr; // 附加属性
    private Date createTime;     // 创建时间
    private List<ThumbnailInfo> thumbnails; // 缩略图信息
}
```

## 错误处理

```java
@RestControllerAdvice
public class FileUploadExceptionHandler {

    @ExceptionHandler(FileStorageRuntimeException.class)
    public R<Void> handleFileStorageException(FileStorageRuntimeException e) {
        log.error("文件上传失败: {}", e.getMessage());
        return R.fail("文件上传失败: " + e.getMessage());
    }

    @ExceptionHandler(MaxUploadSizeExceededException.class)
    public R<Void> handleMaxUploadSizeException(MaxUploadSizeExceededException e) {
        log.error("文件大小超出限制: {}", e.getMessage());
        return R.fail("文件大小超出限制");
    }

    @ExceptionHandler(Exception.class)
    public R<Void> handleException(Exception e) {
        log.error("文件上传异常: {}", e.getMessage());
        return R.fail("文件上传异常");
    }
}
```

## 性能优化

### 1. 异步上传

```java
@Async
public CompletableFuture<FileInfo> uploadAsync(UploadedFile file) {
    return CompletableFuture.completedFuture(fileStorageService.of(file).upload());
}
```

### 2. 缓存策略

```java
// 使用缓存存储文件信息，避免重复查询
@Cacheable(value = "fileInfo", key = "#fileId")
public FileInfo getFileInfo(String fileId) {
    return fileStorageService.getFileInfo(fileId);
}
```

### 3. CDN 配置

```yaml
jimuqu:
  file-storage:
    platforms:
      aliyun-oss-1:
        platform: aliyun-oss
        domain: "https://your-cdn-domain.com/"  # 使用 CDN 域名
        # 其他配置...
```

## 注意事项

1. **文件大小限制**: 根据业务需求设置合理的文件大小限制
2. **文件类型验证**: 严格验证上传文件的类型，防止恶意文件上传
3. **存储安全**: 合理配置存储平台的访问权限
4. **异常处理**: 添加完善的异常处理机制
5. **日志记录**: 记录文件上传操作日志，便于追踪和审计
6. **备份策略**: 重要文件考虑多平台备份

---

*该指南基于 x-file-storage 框架的实际使用经验整理，如有更新请参考官方文档。*